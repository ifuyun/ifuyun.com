<main>
  <div class="puzzle" [class.p-puzzle]="!isMobile" [class.m-puzzle]="isMobile" #puzzle>
    <div class="puzzle-board">
      <canvas class="puzzle-canvas" #puzzleCanvas [attr.width]="canvasWidth" [attr.height]="canvasHeight"></canvas>
    </div>
    @if (!isMobile) {
      <div class="puzzle-control">
        <div>
          <a nz-dropdown
             class="puzzle-difficulty"
             [nzDropdownMenu]="difficulty"
             [nzDisabled]="gameStatus === 'playing' || gameStatus === 'paused'"
             nzPlacement="topLeft">{{ activeDifficulty.name }}ç‰‡<nz-icon nzType="down"/></a>
          @if (gameStatus === 'ready' || gameStatus === 'completed') {
            <a nz-button
               nzType="link"
               class="icon-btn"
               title="å¼€å§‹"
               (click)="startGame()"><span class="fi fi-play"></span></a>
          }
          @if (gameStatus === 'playing') {
            <a nz-button
               nzType="link"
               title="æš‚åœ"
               (click)="pauseGame()"><nz-icon nzType="pause"/></a>
          }
          @if (gameStatus === 'paused') {
            <a nz-button
               nzType="link"
               class="icon-btn"
               title="ç»§ç»­"
               (click)="resumeGame()"><span class="fi fi-play"></span></a>
          }
          <a nz-button
             nzType="link"
             class="icon-btn"
             title="åœæ­¢"
             [disabled]="gameStatus !== 'playing' && gameStatus !== 'paused'"
             (click)="stopGame()"><span class="fi fi-stop"></span></a>
          <a nz-button
             nzType="link"
             title="é‡æ–°å¼€å§‹"
             [disabled]="gameStatus === 'ready'"
             (click)="restartGame()"><nz-icon nzType="reload"/></a>
          <a nz-button
             nzType="link"
             title="æ”¾å¤§"
             [disabled]="gameStatus !== 'playing' && gameStatus !== 'completed'"
             (click)="zoom()"><nz-icon nzType="zoom-in"/></a>
          <a nz-button
             nzType="link"
             title="ç¼©å°"
             [disabled]="gameStatus !== 'playing' && gameStatus !== 'completed'"
             (click)="zoom(false)"><nz-icon nzType="zoom-out"/></a>
          @if (isFullScreen) {
            <a nz-button
               nzType="link"
               class="icon-btn"
               [title]="isArranged ? 'å–æ¶ˆæ‰©æ•£' : 'å››å‘¨æ‰©æ•£'"
               [disabled]="gameStatus !== 'playing'"
               (click)="arrange()"><span class="fi {{ isArranged ? 'fi-fullscreen-exit' : 'fi-fullscreen'}}"></span></a>
          }
          <a nz-button
             nzType="link"
             [title]="isFullScreen ? 'é€€å‡ºå…¨å±' : 'å…¨å±'"
             (click)="fullscreen()"><nz-icon [nzType]="isFullScreen ? 'fullscreen-exit' : 'fullscreen'"/></a>
        </div>
        <div>
          <span>{{ gameTime | duration }} / {{ gamePercent }}%</span>
        </div>
        <div>
          @if (scaledImage) {
            <a nz-button
               nz-popover
               nzType="link"
               title="é¢„è§ˆ"
               [nzPopoverContent]="popoverTemplate"
               nzPopoverPlacement="topRight"><nz-icon nzType="picture"/></a>
            <ng-template #popoverTemplate>
              <img [style.width]="'300px'"
                   [style.cursor]="'zoom-in'"
                   [src]="scaledImage.src"
                   (click)="showFullImage()"
                   alt="é¢„è§ˆ"/>
            </ng-template>
          } @else {
            <a nz-button disabled nzType="link" title="é¢„è§ˆ"><nz-icon nzType="picture"/></a>
          }
          <a nz-button
             nzType="link"
             [href]="detailLink"
             target="_blank"
             title="ã€Š{{wallpaper?.wallpaperCopyright}}ã€‹å£çº¸è¯¦æƒ…"><nz-icon nzType="info-circle"/></a>
          @if (downloading) {
            <a nz-button nzType="link" title="ä¸‹è½½ä¸­..."><nz-icon nzType="loading"/></a>
          } @else {
            <a nz-button
               nzType="link"
               class="icon-btn"
               (click)="download()"
               title="ä¸‹è½½ã€Š{{wallpaper?.wallpaperCopyright}}ã€‹é«˜æ¸…å£çº¸"><span class="fi fi-download"></span></a>
          }
        </div>
      </div>
    } @else {
      <div class="puzzle-control">
        <div>
          <a nz-dropdown
             class="puzzle-difficulty"
             [nzDropdownMenu]="difficulty"
             [nzDisabled]="gameStatus === 'playing' || gameStatus === 'paused'"
             nzPlacement="topLeft">{{ activeDifficulty.name }}ç‰‡<nz-icon nzType="down"/></a>
          @if (gameStatus === 'ready' || gameStatus === 'completed') {
            <a nz-button
               nzType="link"
               class="icon-btn"
               title="å¼€å§‹"
               (click)="startGame()"><span class="fi fi-play"></span></a>
          }
          @if (gameStatus === 'playing') {
            <a nz-button nzType="link" title="æš‚åœ" (click)="pauseGame()"><nz-icon nzType="pause"/></a>
          }
          @if (gameStatus === 'paused') {
            <a nz-button
               nzType="link"
               class="icon-btn"
               title="ç»§ç»­"
               (click)="resumeGame()"><span class="fi fi-play"></span></a>
          }
          <a nz-button
             nzType="link"
             class="icon-btn"
             title="åœæ­¢"
             [disabled]="gameStatus !== 'playing' && gameStatus !== 'paused'"
             (click)="stopGame()"><span class="fi fi-stop"></span></a>
          <a nz-button
             nzType="link"
             [title]="isFullScreen ? 'é€€å‡ºå…¨å±' : 'å…¨å±'"
             (click)="fullscreen()"><nz-icon [nzType]="isFullScreen ? 'fullscreen-exit' : 'fullscreen'"/></a>
          @if (scaledImage) {
            <a nz-button
               nz-popover
               nzType="link"
               title="é¢„è§ˆ"
               [nzPopoverContent]="mPopoverTemplate"
               nzPopoverPlacement="topRight"><nz-icon nzType="picture"/></a>
            <ng-template #mPopoverTemplate>
              <img [style.width]="'270px'"
                   [style.cursor]="'zoom-in'"
                   [src]="scaledImage.src"
                   (click)="showFullImage()"
                   alt="é¢„è§ˆ"/>
            </ng-template>
          } @else {
            <a nz-button disabled nzType="link" title="é¢„è§ˆ"><nz-icon nzType="picture"/></a>
          }
          <a nz-button
             nzType="link"
             [href]="detailLink"
             target="_blank"
             title="ã€Š{{wallpaper?.wallpaperCopyright}}ã€‹å£çº¸è¯¦æƒ…"><nz-icon nzType="info-circle"/></a>
        </div>
        <div>
          <span>{{ gameTime | duration }} / {{ gamePercent }}%</span>
        </div>
      </div>
    }
    @if (gameStatus === 'ready' || gameStatus === 'paused') {
      <div class="puzzle-mask">
        @if (gameStatus === 'ready') {
          <div (click)="startGame()"><span class="fi fi-play"></span><span>å¼€å§‹æ¸¸æˆ</span></div>
        } @else if (gameStatus === 'paused') {
          <div (click)="resumeGame()"><span class="fi fi-play"></span><span>ç»§ç»­æ¸¸æˆ</span></div>
        }
      </div>
    }
  </div>
  @if (isBrowser) {
    <div class="ranking">
      <h2><span class="fi fi-trophy-fill"></span><span>æ’è¡Œæ¦œï¼ˆ{{ activeDifficulty.pieces }} ç‰‡ï¼‰</span></h2>
      <div class="ranking-table">
        <nz-table nzOuterBordered
                  nzTableLayout="fixed"
                  nzSize="middle"
                  [nzData]="rankings"
                  [nzFrontPagination]="true"
                  [nzShowPagination]="false"
                  [nzHideOnSinglePage]="true"
                  [nzLoading]="rankingLoading"
                  [nzNoResult]="emptyRankingTpl">
          <thead>
          <tr>
            <th nzAlign="center" nzWidth="60px">åæ¬¡</th>
            <th nzAlign="center">ç©å®¶</th>
            <th nzAlign="center" nzWidth="70px">ç”¨æ—¶</th>
            <th nzAlign="center" [nzWidth]="isMobile ? '110px' : '150px'">æ—¶é—´</th>
          </tr>
          </thead>
          <tbody>
            @for (item of rankings; track item; let i = $index) {
              <tr [class.active]="item.faId === faId || item.userId === userId">
                <td nzAlign="center" [title]="i + 1"><span class="hot-num">{{ i + 1 }}</span></td>
                <td nzEllipsis [title]="item.user?.userNickname || 'åŒ¿åç”¨æˆ·'">
                  {{ item.user?.userNickname || 'åŒ¿åç”¨æˆ·' }}{{ item.faId === faId || item.userId === userId ? 'ï¼ˆä½ ï¼‰' : '' }}
                </td>
                <td nzAlign="right"
                    nzEllipsis
                    [title]="item.jigsawLogDuration | duration">{{ item.jigsawLogDuration | duration }}</td>
                <td nzAlign="center"
                    [title]="item.jigsawLogEnd | date: dateFormat">{{ item.jigsawLogEnd | date: dateFormat }}</td>
              </tr>
            }
          </tbody>
        </nz-table>
        <ng-template #emptyRankingTpl>
          <nz-empty nzNotFoundImage="simple" nzNotFoundContent="ğŸš€ ç”¨é€Ÿåº¦ä¸æ™ºæ…§å¾æœæ‹¼å›¾ï¼Œæ‹¿ä¸‹æ¦œä¸€ï¼"></nz-empty>
        </ng-template>
      </div>
    </div>
  }
</main>
<nz-dropdown-menu #difficulty="nzDropdownMenu">
  <ul nz-menu nzSelectable>
    @for (item of difficultyList; track item.name) {
      <li nz-menu-item
          [nzSelected]="activeDifficulty.name === item.name"
          (click)="setDifficulty(item)">{{ item.name + 'ç‰‡(' + item.rows + 'x' + item.cols + ')' }}</li>
    }
  </ul>
</nz-dropdown-menu>
@if (isBrowser) {
  <ng-template #confirmModalContent>
    <div class="confirm-progress">
      @if (cachedJigsaw) {
        <p><span>æ‹¼å›¾ï¼š</span><span>{{ wallpaper?.wallpaperCopyright }}</span></p>
        <p><span>æ—¶é—´ï¼š</span><span>{{ cachedJigsaw.t | date:'yyyy-MM-dd HH:mm:ss' }}</span></p>
        <p><span>éš¾åº¦ï¼š</span><span>{{ cachedJigsaw.c }} ç‰‡</span></p>
        <p><span>è¿›åº¦ï¼š</span><span>{{ (cachedJigsaw.s / (cachedJigsaw.c - 1) * 100).toFixed(1) }}%</span></p>
        <p><span>ç”¨æ—¶ï¼š</span><span>{{ cachedJigsaw.d | duration }}</span></p>
      }
    </div>
  </ng-template>
}
