<main>
  <div class="puzzle" [class.p-puzzle]="!isMobile" [class.m-puzzle]="isMobile" #puzzle>
    <div class="puzzle-board">
      <canvas class="puzzle-canvas" #puzzleCanvas [attr.width]="canvasWidth" [attr.height]="canvasHeight"></canvas>
    </div>
    @if (!isMobile) {
      <div class="puzzle-control">
        <div>
          <a nz-dropdown
             class="puzzle-difficulty"
             [nzDropdownMenu]="difficulty"
             nzPlacement="topLeft"
             [nzDisabled]="gameStatus === 'playing' || gameStatus === 'paused'">
            {{ activeDifficulty.name }}Áâá
            <nz-icon nzType="down"/>
          </a>
          <a nz-button
             nzType="link"
             class="icon-btn"
             title="ÂºÄÂßã"
             *ngIf="gameStatus === 'ready' || gameStatus === 'completed'"
             (click)="startGame()">
            <span class="fi fi-play"></span>
          </a>
          <a nz-button nzType="link" title="ÊöÇÂÅú" *ngIf="gameStatus === 'playing'" (click)="pauseGame()">
            <nz-icon nzType="pause"/>
          </a>
          <a nz-button nzType="link" class="icon-btn" title="ÁªßÁª≠" *ngIf="gameStatus === 'paused'" (click)="resumeGame()">
            <span class="fi fi-play"></span>
          </a>
          <a nz-button
             nzType="link"
             class="icon-btn"
             title="ÂÅúÊ≠¢"
             [disabled]="gameStatus !== 'playing' && gameStatus !== 'paused'"
             (click)="stopGame()">
            <span class="fi fi-stop"></span>
          </a>
          <a nz-button nzType="link" title="ÈáçÊñ∞ÂºÄÂßã" [disabled]="gameStatus === 'ready'" (click)="restartGame()">
            <nz-icon nzType="reload"/>
          </a>
          <a nz-button
             nzType="link"
             title="ÊîæÂ§ß"
             [disabled]="gameStatus !== 'playing' && gameStatus !== 'completed'"
             (click)="zoom()">
            <nz-icon nzType="zoom-in"/>
          </a>
          <a nz-button
             nzType="link"
             title="Áº©Â∞è"
             [disabled]="gameStatus !== 'playing' && gameStatus !== 'completed'"
             (click)="zoom(false)">
            <nz-icon nzType="zoom-out"/>
          </a>
          <a nz-button nzType="link" [title]="isFullScreen ? 'ÈÄÄÂá∫ÂÖ®Â±è' : 'ÂÖ®Â±è'" (click)="fullscreen()">
            <nz-icon [nzType]="isFullScreen ? 'fullscreen-exit' : 'fullscreen'"/>
          </a>
        </div>
        <div>
          <span>{{ gameTime | duration }} / {{ gamePercent }}%</span>
        </div>
        <div>
          @if (scaledImage) {
            <a nz-button
               nz-popover
               nzType="link"
               title="È¢ÑËßà"
               [nzPopoverContent]="popoverTemplate"
               nzPopoverPlacement="topRight">
              <nz-icon nzType="picture"/>
            </a>
            <ng-template #popoverTemplate>
              <img [style.width]="'300px'"
                   [style.cursor]="'zoom-in'"
                   [src]="scaledImage.src"
                   (click)="showFullImage()"
                   alt="È¢ÑËßà"/>
            </ng-template>
          } @else {
            <a nz-button disabled nzType="link" title="È¢ÑËßà">
              <nz-icon nzType="picture"/>
            </a>
          }
          <a nz-button
             nzType="link"
             [routerLink]="'/wallpaper/' + wallpaper?.wallpaperId"
             [queryParams]="langParams"
             target="_blank"
             title="„Ää{{wallpaper?.wallpaperCopyright}}„ÄãÂ£ÅÁ∫∏ËØ¶ÊÉÖ">
            <nz-icon nzType="info-circle"/>
          </a>
          @if (downloading) {
            <a nz-button nzType="link" class="icon-btn" title="‰∏ãËΩΩ‰∏≠...">
              <nz-icon nzType="loading"/>
            </a>
          } @else {
            <a nz-button
               nzType="link"
               class="icon-btn"
               (click)="download()"
               title="‰∏ãËΩΩ„Ää{{wallpaper?.wallpaperCopyright}}„ÄãÈ´òÊ∏ÖÂ£ÅÁ∫∏"><span class="fi fi-download"></span></a>
          }
        </div>
      </div>
    } @else {
      <div class="puzzle-control">
        <div>
          <a nz-dropdown
             class="puzzle-difficulty"
             [nzDropdownMenu]="difficulty"
             nzPlacement="topLeft"
             [nzDisabled]="gameStatus === 'playing' || gameStatus === 'paused'">
            {{ activeDifficulty.name }}Áâá
            <nz-icon nzType="down"/>
          </a>
          <a nz-button
             nzType="link"
             class="icon-btn"
             title="ÂºÄÂßã"
             *ngIf="gameStatus === 'ready' || gameStatus === 'completed'"
             (click)="startGame()">
            <span class="fi fi-play"></span>
          </a>
          <a nz-button nzType="link" title="ÊöÇÂÅú" *ngIf="gameStatus === 'playing'" (click)="pauseGame()">
            <nz-icon nzType="pause"/>
          </a>
          <a nz-button nzType="link" class="icon-btn" title="ÁªßÁª≠" *ngIf="gameStatus === 'paused'" (click)="resumeGame()">
            <span class="fi fi-play"></span>
          </a>
          <a nz-button
             nzType="link"
             class="icon-btn"
             title="ÂÅúÊ≠¢"
             [disabled]="gameStatus !== 'playing' && gameStatus !== 'paused'"
             (click)="stopGame()">
            <span class="fi fi-stop"></span>
          </a>
          <a nz-button nzType="link" [title]="isFullScreen ? 'ÈÄÄÂá∫ÂÖ®Â±è' : 'ÂÖ®Â±è'" (click)="fullscreen()">
            <nz-icon [nzType]="isFullScreen ? 'fullscreen-exit' : 'fullscreen'"/>
          </a>
          @if (scaledImage) {
            <a nz-button
               nz-popover
               nzType="link"
               title="È¢ÑËßà"
               [nzPopoverContent]="popoverTemplate"
               nzPopoverPlacement="topRight">
              <nz-icon nzType="picture"/>
            </a>
            <ng-template #popoverTemplate>
              <img [style.width]="'270px'"
                   [style.cursor]="'zoom-in'"
                   [src]="scaledImage.src"
                   (click)="showFullImage()"
                   alt="È¢ÑËßà"/>
            </ng-template>
          } @else {
            <a nz-button disabled nzType="link" title="È¢ÑËßà">
              <nz-icon nzType="picture"/>
            </a>
          }
          <a nz-button
             nzType="link"
             [routerLink]="'/wallpaper/' + wallpaper?.wallpaperId"
             [queryParams]="langParams"
             target="_blank"
             title="„Ää{{wallpaper?.wallpaperCopyright}}„ÄãÂ£ÅÁ∫∏ËØ¶ÊÉÖ">
            <nz-icon nzType="info-circle"/>
          </a>
        </div>
        <div>
          <span>{{ gameTime | duration }} / {{ gamePercent }}%</span>
        </div>
      </div>
    }
  </div>
  <div class="ranking" *ngIf="isBrowser">
    <h2><span class="fi fi-trophy-fill"></span><span>ÊéíË°åÊ¶úÔºà{{activeDifficulty.pieces}} ÁâáÔºâ</span></h2>
    <div class="ranking-table">
      <nz-table nzOuterBordered
                nzTableLayout="fixed"
                nzSize="middle"
                [nzData]="rankings"
                [nzFrontPagination]="true"
                [nzShowPagination]="false"
                [nzHideOnSinglePage]="true"
                [nzLoading]="rankingLoading"
                [nzNoResult]="emptyRankingTpl">
        <thead>
        <tr>
          <th nzAlign="center" nzWidth="60px">ÂêçÊ¨°</th>
          <th nzAlign="center">Áé©ÂÆ∂</th>
          <th nzAlign="center" nzWidth="70px">Áî®Êó∂</th>
          <th nzAlign="center" [nzWidth]="isMobile ? '110px' : '150px'">Êó∂Èó¥</th>
        </tr>
        </thead>
        <tbody>
        <tr [class.active]="item.faId === faId || item.userId === userId" *ngFor="let item of rankings; let i = index">
          <td nzAlign="center" [title]="i + 1"><span class="hot-num">{{ i + 1 }}</span></td>
          <td nzEllipsis [title]="item.user?.userNickname || 'ÂåøÂêçÁî®Êà∑'">
            {{ item.user?.userNickname || 'ÂåøÂêçÁî®Êà∑' }}{{ item.faId === faId || item.userId === userId ? 'Ôºà‰Ω†Ôºâ' : '' }}
          </td>
          <td nzAlign="right" nzEllipsis [title]="item.jigsawLogDuration | duration">{{ item.jigsawLogDuration | duration }}</td>
          <td nzAlign="center" [title]="item.jigsawLogEnd | date: dateFormat">{{ item.jigsawLogEnd | date: dateFormat }}</td>
        </tr>
        </tbody>
      </nz-table>
      <ng-template #emptyRankingTpl>
        <nz-empty nzNotFoundImage="simple" nzNotFoundContent="üöÄ Áî®ÈÄüÂ∫¶‰∏éÊô∫ÊÖßÂæÅÊúçÊãºÂõæÔºåÊãø‰∏ãÊ¶ú‰∏ÄÔºÅ"></nz-empty>
      </ng-template>
    </div>
  </div>
</main>
<nz-dropdown-menu #difficulty="nzDropdownMenu">
  <ul nz-menu nzSelectable>
    @for (item of difficultyList; track item.name) {
      <li nz-menu-item
          [nzSelected]="activeDifficulty.name === item.name"
          (click)="setDifficulty(item)">{{ item.name + 'Áâá(' + item.rows + 'x' + item.cols + ')' }}
      </li>
    }
  </ul>
</nz-dropdown-menu>
@if (isBrowser) {
  <app-login-modal *ngIf="loginVisible" (close)="closeLoginModal()"></app-login-modal>
  <ng-template #confirmModalContent>
    <div class="confirm-progress">
      @if (cachedJigsaw) {
        <p><span>ÊãºÂõæÔºö</span><span>{{ wallpaper?.wallpaperCopyright }}</span></p>
        <p><span>Êó∂Èó¥Ôºö</span><span>{{ cachedJigsaw.t | date:'yyyy-MM-dd HH:mm:ss' }}</span></p>
        <p><span>ÈöæÂ∫¶Ôºö</span><span>{{ cachedJigsaw.c }} Áâá</span></p>
        <p><span>ËøõÂ∫¶Ôºö</span><span>{{ (cachedJigsaw.s / (cachedJigsaw.c - 1) * 100).toFixed(1) }}%</span></p>
        <p><span>Áî®Êó∂Ôºö</span><span>{{ cachedJigsaw.d | duration }}</span></p>
      }
    </div>
  </ng-template>
}
